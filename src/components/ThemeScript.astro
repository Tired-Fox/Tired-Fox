---
---
<script>
    import { Toast } from '../scripts/toast.ts';    

    type Theme = 'light' | 'dark';
    
    const storageKey = 'TiredFox-';
    let theme: Theme = 'light';
    const themeNotify = new Toast('The color theme can be changed with <code>Alt + T</code>');
    
    export function setTheme(new_theme: Theme) {
        theme = new_theme;
        saveTheme(theme);
        console.log(document.body, theme);
        document.body.setAttribute("data-theme", theme);
    }
    
    export function saveTheme(theme: Theme) {
        localStorage.setItem(`${storageKey}Theme`, theme);
    }
    
    export function loadTheme(): Theme {
        return localStorage.getItem(`${storageKey}Theme`) === 'dark' ? 'dark' : 'light';
    }
    
    export function toggleTheme() {
        if (theme === 'light') {
            setTheme('dark')
        } else {
            setTheme('light')
        }
    }

    function getToastedTheme() {
        const toastedDate = new Date(Number(localStorage.getItem(`${storageKey}Toast-Theme`) || '0'));
        console.log(Number.isNaN(toastedDate), toastedDate, new Date);
        return Number.isNaN(toastedDate) || toastedDate <= new Date ? false : true;
    }

    function setToastedTheme(expires: number) {
        let currDate = new Date();
        let result = currDate.setDate(currDate.getDate() + expires);
        localStorage.setItem(`${storageKey}Toast-Theme`, result.toString())
    }

    function toastTheme(duration?: number) {
        // Show this toast message that will disapear in 5 seconds
        if (themeNotify.activate(duration)) {
            // Toast won't auto show for another 30 days
            setToastedTheme(30)
        }
        
    }

    window.onload = () => {
        setTheme(loadTheme());
        document.addEventListener("keydown", (event) => {
            if (event.altKey && event.key === 't') {
                console.log('Toggling Theme');
                setTheme(theme === 'light' ? 'dark' : 'light')
            }
        })

        const themeHelp = document.getElementById('theme-help');
        if (themeHelp) {
            themeHelp.addEventListener("click", () => {
                toastTheme()
            })
        }

        let notify = setInterval(
            () => {
                if (!getToastedTheme()) {
                    toastTheme(5000);
                }
                clearInterval(notify);
            },
            1000
        );
    }
</script>